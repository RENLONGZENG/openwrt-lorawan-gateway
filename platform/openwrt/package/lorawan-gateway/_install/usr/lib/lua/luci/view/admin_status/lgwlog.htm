<!-- 
	流量图：
	1.上行流量
	2.下行流量
	3.gateway stat流量
	
	报文数统计表：
	##### 2021-08-10 09:12:24 UTC #####


	### [UPSTREAM] ###
	# RF packets received by concentrator: 0
	# CRC_OK: 0.00%, CRC_FAIL: 0.00%, NO_CRC: 0.00%
	# RF packets forwarded: 0 (0 bytes)
	# PUSH_DATA datagrams sent: 1 (122 bytes)
	# PUSH_DATA acknowledged: 0.00%

	UPSTREAM 		RF packets received by concentrator: 0
							CRC_OK: 0.00%			CRC_FAIL: 0.00%			NO_CRC: 0.00%
							RF packets forwarded: 0
							PUSH_DATA datagrams sent: 1
							PUSH_DATA acknowledged: 0.00% 

	### [DOWNSTREAM] ###
	# PULL_DATA sent: 3 (0.00% acknowledged)
	# PULL_RESP(onse) datagrams received: 0 (0 bytes)
	# RF packets sent to concentrator: 0 (0 bytes)
	# TX errors: 0

	DOWNSTREAM	PULL_DATA sent: 3 (0.00% acknowledged)
							PULL_RESP(onse) datagrams received: 0 (0 bytes)
							RF packets sent to concentrator: 0 (0 bytes)
							TX errors: 0

	### SX1302 Status ###
	# SX1302 counter (INST): 1622371518
	# SX1302 counter (PPS): 0
	# BEACON queued: 0
	# BEACON sent so far: 0
	# BEACON rejected: 0

	SX1302 Status SX1302 counter (INST): 1622371518
					SX1302 counter (PPS): 0
					BEACON queued: 0
					BEACON sent so far: 0
					BEACON rejected: 0

	### [JIT] ###
	src/jitqueue.c:440:jit_print_queue(): INFO: [jit] queue is empty
	#--------
	src/jitqueue.c:440:jit_print_queue(): INFO: [jit] queue is empty


	### [GPS] ###
	# Invalid time reference (age: 1628586744 sec)
	# no valid GPS coordinates available yet
	GPS		Invalid time reference (age: 1628586744 sec)
			no valid GPS coordinates available yet


	##### END #####

	上下行消息实时显示：
	1.上行消息实时信息
	2.下行消息实时信息
	3.gateway stat信息
	4.报警日志
 -->

<%+header%>

<script type="text/javascript" src="<%=resource%>/cbi.js"></script>
<script type="text/javascript">//<![CDATA[
	// var bwxhr = new XHR();

	// var G;
	// var TIME  = 0;
	// var UDP   = 1;
	// var TCP   = 2;
	// var OTHER = 3;

	// var width  = 760;
	// var height = 300;
	// var step   = 5;

	// var data_wanted = Math.floor(width / step);
	// var data_fill   = 0;
	// var data_stamp  = 0;

	// var data_udp = [ ];
	// var data_tcp = [ ];
	// var data_otr = [ ];

	// var line_udp;
	// var line_tcp;

	// var label_25;
	// var label_50;
	// var label_75;

	// var label_udp_cur;
	// var label_udp_avg;
	// var label_udp_peak;

	// var label_tcp_cur;
	// var label_tcp_avg;
	// var label_tcp_peak;

	// var label_otr_cur;
	// var label_otr_avg;
	// var label_otr_peak;

	// var label_scale;

	// var conn_table;

	// var dns_cache = { };


	// /* wait for SVG */
	// window.setTimeout(
	// 	function() {
	// 		var svg = document.getElementById('bwsvg');

	// 		try {
	// 			G = svg.getSVGDocument
	// 				? svg.getSVGDocument() : svg.contentDocument;
	// 		}
	// 		catch(e) {
	// 			G = document.embeds['bwsvg'].getSVGDocument();
	// 		}

	// 		if (!G)
	// 		{
	// 			window.setTimeout(arguments.callee, 1000);
	// 		}
	// 		else
	// 		{
	// 			/* find sizes */
	// 			width       = svg.offsetWidth  - 2;
	// 			height      = svg.offsetHeight - 2;
	// 			data_wanted = Math.ceil(width / step);

	// 			/* prefill datasets */
	// 			for (var i = 0; i < data_wanted; i++)
	// 			{
	// 				data_udp[i] = 0;
	// 				data_tcp[i] = 0;
	// 				data_otr[i] = 0;
	// 			}

	// 			/* find svg elements */
	// 			line_udp = G.getElementById('udp');
	// 			line_tcp = G.getElementById('tcp');
	// 			line_otr = G.getElementById('other');

	// 			label_25 = G.getElementById('label_25');
	// 			label_50 = G.getElementById('label_50');
	// 			label_75 = G.getElementById('label_75');

	// 			label_udp_cur  = document.getElementById('lb_udp_cur');
	// 			label_udp_avg  = document.getElementById('lb_udp_avg');
	// 			label_udp_peak = document.getElementById('lb_udp_peak');

	// 			label_tcp_cur  = document.getElementById('lb_tcp_cur');
	// 			label_tcp_avg  = document.getElementById('lb_tcp_avg');
	// 			label_tcp_peak = document.getElementById('lb_tcp_peak');

	// 			label_otr_cur  = document.getElementById('lb_otr_cur');
	// 			label_otr_avg  = document.getElementById('lb_otr_avg');
	// 			label_otr_peak = document.getElementById('lb_otr_peak');

	// 			label_scale    = document.getElementById('scale');

	// 			conn_table     = document.getElementById('connections');


	// 			/* plot horizontal time interval lines */
	// 			for (var i = width % (step * 60); i < width; i += step * 60)
	// 			{
	// 				var line = G.createElementNS('http://www.w3.org/2000/svg', 'line');
	// 					line.setAttribute('x1', i);
	// 					line.setAttribute('y1', 0);
	// 					line.setAttribute('x2', i);
	// 					line.setAttribute('y2', '100%');
	// 					line.setAttribute('style', 'stroke:black;stroke-width:0.1');

	// 				var text = G.createElementNS('http://www.w3.org/2000/svg', 'text');
	// 					text.setAttribute('x', i + 5);
	// 					text.setAttribute('y', 15);
	// 					text.setAttribute('style', 'fill:#999999; font-size:9pt');
	// 					text.appendChild(G.createTextNode(Math.round((width - i) / step / 60) + 'm'));

	// 				label_25.parentNode.appendChild(line);
	// 				label_25.parentNode.appendChild(text);
	// 			}

	// 			label_scale.innerHTML = String.format('<%:(%d minute window, %d second interval)%>', data_wanted / 60, 3);

	// 			/* render datasets, start update interval */
	// 			XHR.poll(3, '<%=build_url("admin/status/realtime/connections_status")%>', null,
	// 				function(x, json)
	// 				{
	// 					var conn = json.connections;

	// 					while (conn_table.rows.length > 1)
	// 						conn_table.rows[0].parentNode.deleteRow(-1);


	// 					var lookup_queue = [ ];

	// 					conn.sort(function(a, b) {
	// 						return b.bytes - a.bytes;
	// 					});

	// 					for (var i = 0; i < conn.length; i++)
	// 					{
	// 						var c  = conn[i];

	// 						if (c.src == '127.0.0.1' && c.dst == '127.0.0.1')
	// 							continue;

	// 						var tr = conn_table.rows[0].parentNode.insertRow(-1);
	// 						    tr.className = 'cbi-section-table-row cbi-rowstyle-' + (1 + (i % 2));

	// 						if (!dns_cache[c.src])
	// 							lookup_queue.push(c.src);

	// 						if (!dns_cache[c.dst])
	// 							lookup_queue.push(c.dst);

	// 						var src = dns_cache[c.src] || (c.layer3 == 'ipv6' ? '[' + c.src + ']' : c.src);
	// 						var dst = dns_cache[c.dst] || (c.layer3 == 'ipv6' ? '[' + c.dst + ']' : c.dst);

	// 						tr.insertCell(-1).innerHTML = c.layer3.toUpperCase();
	// 						tr.insertCell(-1).innerHTML = c.layer4.toUpperCase();
	// 						tr.insertCell(-1).innerHTML = String.format('%s:%d', src, c.sport);
	// 						tr.insertCell(-1).innerHTML = String.format('%s:%d', dst, c.dport);

	// 						var traf = tr.insertCell(-1);
	// 						    traf.style.whiteSpace = 'nowrap';
	// 						    traf.innerHTML = String.format('%1024.2mB (%d <%:Pkts.%>)', c.bytes, c.packets);
	// 					}

	// 					if (lookup_queue.length > 0)
	// 						XHR.get('<%=build_url("admin/status/nameinfo")%>/' + lookup_queue.slice(0, 100).join('/'), null,
	// 							function(x, json)
	// 							{
	// 								for (var addr in json)
	// 									dns_cache[addr] = json[addr];
	// 							}
	// 						);


	// 					var data = json.statistics;

	// 					var data_max   = 0;
	// 					var data_scale = 0;

	// 					var data_udp_avg = 0;
	// 					var data_tcp_avg = 0;
	// 					var data_otr_avg = 0;

	// 					var data_udp_peak = 0;
	// 					var data_tcp_peak = 0;
	// 					var data_otr_peak = 0;

	// 					for (var i = data_stamp ? 0 : 1; i < data.length; i++)
	// 					{
	// 						/* skip overlapping entries */
	// 						if (data[i][TIME] <= data_stamp)
	// 							continue;

	// 						data_udp.push(data[i][UDP]);
	// 						data_tcp.push(data[i][TCP]);
	// 						data_otr.push(data[i][OTHER]);
	// 					}

	// 					/* cut off outdated entries */
	// 					data_udp = data_udp.slice(data_udp.length - data_wanted, data_udp.length);
	// 					data_tcp = data_tcp.slice(data_tcp.length - data_wanted, data_tcp.length);
	// 					data_otr = data_otr.slice(data_otr.length - data_wanted, data_otr.length);

	// 					/* find peak */
	// 					for (var i = 0; i < data_udp.length; i++)
	// 					{
	// 						data_max = Math.max(data_max, data_udp[i]);
	// 						data_max = Math.max(data_max, data_tcp[i]);
	// 						data_max = Math.max(data_max, data_otr[i]);

	// 						data_udp_peak = Math.max(data_udp_peak, data_udp[i]);
	// 						data_tcp_peak = Math.max(data_tcp_peak, data_tcp[i]);
	// 						data_otr_peak = Math.max(data_otr_peak, data_otr[i]);

	// 						if (i > 0)
	// 						{
	// 							data_udp_avg = (data_udp_avg + data_udp[i]) / 2;
	// 							data_tcp_avg = (data_tcp_avg + data_tcp[i]) / 2;
	// 							data_otr_avg = (data_otr_avg + data_otr[i]) / 2;
	// 						}
	// 						else
	// 						{
	// 							data_udp_avg = data_udp[i];
	// 							data_tcp_avg = data_tcp[i];
	// 							data_otr_avg = data_otr[i];
	// 						}
	// 					}

	// 					/* remember current timestamp, calculate horizontal scale */
	// 					data_stamp = data[data.length-1][TIME];
	// 					data_scale = height / (data_max * 1.1);


	// 					/* plot data */
	// 					var pt_udp = '0,' + height;
	// 					var pt_tcp = '0,' + height;
	// 					var pt_otr = '0,' + height;

	// 					var y_udp = 0;
	// 					var y_tcp = 0;
	// 					var y_otr = 0;

	// 					for (var i = 0; i < data_udp.length; i++)
	// 					{
	// 						var x = i * step;

	// 						y_udp = height - Math.floor(data_udp[i] * data_scale);
	// 						y_tcp = height - Math.floor(data_tcp[i] * data_scale);
	// 						y_otr = height - Math.floor(data_otr[i] * data_scale);

	// 						pt_udp += ' ' + x + ',' + y_udp;
	// 						pt_tcp += ' ' + x + ',' + y_tcp;
	// 						pt_otr += ' ' + x + ',' + y_otr;
	// 					}

	// 					pt_udp += ' ' + width + ',' + y_udp + ' ' + width + ',' + height;
	// 					pt_tcp += ' ' + width + ',' + y_tcp + ' ' + width + ',' + height;
	// 					pt_otr += ' ' + width + ',' + y_otr + ' ' + width + ',' + height;


	// 					var order = [
	// 						[ line_udp, data_udp[data_udp.length-1] ],
	// 						[ line_tcp, data_tcp[data_tcp.length-1] ],
	// 						[ line_otr, data_otr[data_otr.length-1] ]
	// 					];

	// 					order.sort(function(a, b) { return b[1] - a[1] });

	// 					for (var i = 0; i < order.length; i++)
	// 						order[i][0].parentNode.appendChild(order[i][0]);


	// 					line_udp.setAttribute('points', pt_udp);
	// 					line_tcp.setAttribute('points', pt_tcp);
	// 					line_otr.setAttribute('points', pt_otr);

	// 					label_25.firstChild.data = Math.floor(1.1 * 0.25 * data_max);
	// 					label_50.firstChild.data = Math.floor(1.1 * 0.50 * data_max);
	// 					label_75.firstChild.data = Math.floor(1.1 * 0.75 * data_max);

	// 					label_udp_cur.innerHTML = Math.floor(data_udp[data_udp.length-1]);
	// 					label_tcp_cur.innerHTML = Math.floor(data_tcp[data_tcp.length-1]);
	// 					label_otr_cur.innerHTML = Math.floor(data_otr[data_otr.length-1]);

	// 					label_udp_avg.innerHTML = Math.floor(data_udp_avg);
	// 					label_tcp_avg.innerHTML = Math.floor(data_tcp_avg);
	// 					label_otr_avg.innerHTML = Math.floor(data_otr_avg);

	// 					label_udp_peak.innerHTML = Math.floor(data_udp_peak);
	// 					label_tcp_peak.innerHTML = Math.floor(data_tcp_peak);
	// 					label_otr_peak.innerHTML = Math.floor(data_otr_peak);
	// 				}
	// 			);
	// 		}
	// 	}, 1000
	// );

	var lb_utc;
	var lb_up_rf_rc;
	var lb_up_crcok;
	var lb_up_crcfa;
	var lb_up_crcno;
	var lb_up_rf_fo;
	var lb_up_pushsent;
	var lb_up_pushack;
	var lb_down_pullsent;
	var lb_down_pullack;
	var lb_down_pullrc;
	var lb_down_rf_sent;
	var lb_down_txerror;
	var lb_stat_inst;
	var lb_stat_pps;
	var lb_stat_beaconqueue;
	var lb_stat_beaconsent;
	var lb_stat_beaconreject;
	var lb_gps_age;
	window.setTimeout(
		function() {	
			lb_utc = document.getElementById('lb_utc');
			lb_up_rf_rc= document.getElementById('lb_up_rf_rc');
			lb_up_crcok= document.getElementById('lb_up_crcok');
			lb_up_crcfa= document.getElementById('lb_up_crcfa');
			lb_up_crcno= document.getElementById('lb_up_crcno');
			lb_up_rf_fo= document.getElementById('lb_up_rf_fo');
			lb_up_pushsent= document.getElementById('lb_up_pushsent');
			lb_up_pushack= document.getElementById('lb_up_pushack');
			lb_down_pullsent= document.getElementById('lb_down_pullsent');
			lb_down_pullack= document.getElementById('lb_down_pullack');
			lb_down_pullrc= document.getElementById('lb_down_pullrc');
			lb_down_rf_sent= document.getElementById('lb_down_rf_sent');
			lb_down_txerror= document.getElementById('lb_down_txerror');
			lb_stat_inst= document.getElementById('lb_stat_inst');
			lb_stat_pps= document.getElementById('lb_stat_pps');
			lb_stat_beaconqueue= document.getElementById('lb_stat_beaconqueue');
			lb_stat_beaconsent= document.getElementById('lb_stat_beaconsent');
			lb_stat_beaconreject= document.getElementById('lb_stat_beaconreject');
			lb_gps_age= document.getElementById('lb_gps_age');
			XHR.poll(3, '<%=build_url("admin/gateway/lgwlog_status")%>', null,
				function(x, json)
				{
					var data_stat = json.statistics;
					lb_utc.innerHTML = data_stat.utc;
					lb_up_rf_rc.innerHTML = data_stat.up_rf_rc;
					lb_up_crcok.innerHTML = data_stat.up_crcok;
					lb_up_crcfa.innerHTML = data_stat.up_crcfa;
					lb_up_crcno.innerHTML = data_stat.up_crcno;
					lb_up_rf_fo.innerHTML = data_stat.up_rf_fo;
					lb_up_pushsent.innerHTML = data_stat.up_pushsent;
					lb_up_pushack.innerHTML = data_stat.up_pushack;
					lb_down_pullsent.innerHTML = data_stat.down_pullsent;
					lb_down_pullack.innerHTML = data_stat.down_pullack;
					lb_down_pullrc.innerHTML = data_stat.down_pullrc;
					lb_down_rf_sent.innerHTML = data_stat.down_rf_sent;
					lb_down_txerror.innerHTML = data_stat.down_txerror;
					lb_stat_inst.innerHTML = data_stat.stat_inst;
					lb_stat_pps.innerHTML = data_stat.stat_pps;
					lb_stat_beaconqueue.innerHTML = data_stat.stat_beaconqueue;
					lb_stat_beaconsent.innerHTML = data_stat.stat_beaconsent;
					lb_stat_beaconreject.innerHTML = data_stat.stat_beaconreject;
					lb_gps_age.innerHTML = data_stat.gps_age;
				}
			);
		}, 1000
	);
//]]></script>

<h2 name="content"><%:LoraWan GateWay Statistics%></h2>
<br />

<fieldset class="cbi-section" id="cbi-table-table">
	<!-- <legend><%:Active Connections%></legend>

	<embed id="bwsvg" style="width:100%; height:300px; border:1px solid #000000; background-color:#FFFFFF" src="<%=resource%>/connections.svg" />
	<div style="text-align:right"><small id="scale">-</small></div>
	<br /> -->

	<table style="width:100%; table-layout:fixed" cellspacing="5">
		<!-- UTC Time
		2021-08-10 09:12:24 UTC -->
		<tr>
			<td style="text-align:right; vertical-align:top"><strong style="border-bottom:2px solid rgb(0, 255, 132)"><%:Time:%></strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:Utc:%></strong></td>
			<td id="lb_utc">0</td>
		</tr>
		<!-- UPSTREAM RF packets received by concentrator: 0
		CRC_OK: 0.00%			CRC_FAIL: 0.00%			NO_CRC: 0.00%
		RF packets forwarded: 0
		PUSH_DATA datagrams sent: 1
		PUSH_DATA acknowledged: 0.00%  -->
		<tr>
			<td style="text-align:right; vertical-align:top"><strong style="border-bottom:2px solid blue"><%:UPSTREAM:%></strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:RF packets received by concentrator:%></strong></td>
			<td id="lb_up_rf_rc">0</td>
		</tr>
		<tr>
			<td style="text-align:right; vertical-align:top"><strong> </strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:CRC_OK(%):%></strong></td>
			<td id="lb_up_crcok">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:CRC_FAIL(%):%></strong></td>
			<td id="lb_up_crcfa">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:NO_CRC(%):%></strong></td>
			<td id="lb_up_crcno">0</td>
		</tr>
		<tr>
			<td style="text-align:right; vertical-align:top"><strong> </strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:RF packets forwarded:%></strong></td>
			<td id="lb_up_rf_fo">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:PUSH_DATA datagrams sent:%></strong></td>
			<td id="lb_up_pushsent">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:PUSH_DATA acknowledged:%></strong></td>
			<td id="lb_up_pushack">0</td>
		</tr>
		<!-- DOWNSTREAM	PULL_DATA sent: 3 (0.00% acknowledged)
		PULL_RESP(onse) datagrams received: 0 (0 bytes)
		RF packets sent to concentrator: 0 (0 bytes)
		TX errors: 0 -->
		<tr>
			<td style="text-align:right; vertical-align:top"><strong style="border-bottom:2px solid green"><%:DOWNSTREAM:%></strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:PULL_DATA sent:%></strong></td>
			<td id="lb_down_pullsent">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:PULL_DATA acknowledged(%):%></strong></td>
			<td id="lb_down_pullack">0</td>	
		</tr>
		<tr>
			<td style="text-align:right; vertical-align:top"><strong> </strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:PULL_RESP(onse) datagrams received:%></strong></td>
			<td id="lb_down_pullrc">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:RF packets sent to concentrator:%></strong></td>
			<td id="lb_down_rf_sent">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:TX errors:%></strong></td>
			<td id="lb_down_txerror">0</td>
		</tr>
		<!-- SX1302 Status SX1302 counter (INST): 1622371518
		SX1302 counter (PPS): 0
		BEACON queued: 0
		BEACON sent so far: 0
		BEACON rejected: 0 -->
		<tr>
			<td style="text-align:right; vertical-align:top"><strong style="border-bottom:2px solid rgba(255, 0, 225, 0.677)"><%:SX1302 Status:%></strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:SX1302 counter (INST):%></strong></td>
			<td id="lb_stat_inst">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:SX1302 counter (PPS):%></strong></td>
			<td id="lb_stat_pps">0</td>
		</tr>
		<tr>
			<td style="text-align:right; vertical-align:top"><strong> </strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:BEACON queued:%></strong></td>
			<td id="lb_stat_beaconqueue">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:BEACON sent so far:%></strong></td>
			<td id="lb_stat_beaconsent">0</td>
		</tr>
		<tr>
			<td style="text-align:right; vertical-align:top"><strong> </strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:BEACON rejected:%></strong></td>
			<td id="lb_stat_beaconreject">0</td>
		</tr>
		<!-- GPS Invalid time reference (age: 1628586744 sec)
		no valid GPS coordinates available yet -->
		<tr>
			<td style="text-align:right; vertical-align:top"><strong style="border-bottom:2px solid rgb(238, 255, 0)"><%:GPS:%></strong></td>
			<td style="text-align:right; vertical-align:top"><strong><%:Invalid time reference age:(sec):%></strong></td>
			<td id="lb_gps_age">0</td>
			<td style="text-align:right; vertical-align:top"><strong><%:no valid GPS coordinates available yet:%></strong></td>
			<!-- <td id="lb_udp_avg">0</td> -->
		</tr>
	</table>
	<br />

	<div class="cbi-section-node">
		<table class="cbi-section-table" id="connections">
			<tr class="cbi-section-table-titles">
				<th class="cbi-section-table-cell"><%:Network%></th>
				<th class="cbi-section-table-cell"><%:Protocol%></th>
				<th class="cbi-section-table-cell"><%:Source%></th>
				<th class="cbi-section-table-cell"><%:Destination%></th>
				<th class="cbi-section-table-cell"><%:Transfer%></th>
			</tr>

			<tr><td colspan="5"><em><%:Collecting data...%></em></td></tr>
		</table>
	</div>
</fieldset>

<!-- <div id="content_syslog">
  <textarea readonly="readonly" wrap="off" rows="<%=sdata:cmatch("\n")+2%>" id="syslog"><%=sdata:pcdata()%></textarea>
</div> -->

<%+footer%>

